学习笔记

将.class文件加载到内存中，通过验证、准备、解析、初始化等过程，生成可以被使用的java类型，这个过程被称为类加载机制。

类加载机制主要经历七个步骤：
加载->验证->准备->解析->初始化->使用->卸载

**1、加载过程**

加载
通过类的全限定名，将对应的.class文件加载到虚拟机的方法区中，转化为运行时数据结构，并在堆中生成一个Class对象。
验证
验证.class文件的格式是否符合java虚拟机规范

准备
为静态字段设置“零值”即初始值，如 int类型的初始值是0，生成类的方法表。

解析
将符号引用替换为直接引用

初始化
为类变量和静态代码块赋值，这一系列操作被打包为<clinit>方法，一个类的<clinit>被执行前，它的父类<clinit>首先执行完成。
调用构造函数，如果集成了别的类，就先调用父类的构造函数。

**2、类加载时机**
1、jvm执行new、getstatic、putstatic、invokestatic指令时，触发类的初始化：

new指令创建一个对象

获取静态字段或者设置一个静态字段时（final修饰的静态字段除外）

调用静态方法时触发该方法的类的初始化

2、类初始化时若发现父类没有初始化，先触发父类的初始化过程。

3、虚拟机启动，执行main方法时触发该类的初始化

4、通过反射方式，访问类的属性和方法时，触发该类的初始化过程。

5、初次调用MethodHandle实例时，触发MethodHandle指向的类的初始化。

6、java8中，如果一个接口定义了default方法，直接实现或间接实现该接口的类的初始化，就会触发该接口的初始化。
有且仅有上述6种情况会触发类的初始化

3、类加载器
jvm有三种类加载器，启动类加载器（BootstrapClassLoader）、扩展类加载器(ExtendClassLoader)、应用类加载器(AppClassLoader)。

启动类记载器是C++编写的，不属于JVM类库，所以在java中启动类加载器表示null。它负责加载lib/rt.jar中的类，就是核心类，其他类加载器都是ClassLoader的子类。

扩展类加载器加载lib/ext.jar中的类。

应用类记载器加载的是用户编写的类，也就是classpath下的类。

双亲委派机制：类加载器接收到加载请求时，总是先交给父加载器加载，依次往上。若连启动类加载器无法加载，才给子加载器加载，这种方式有效保证了核心类库不被恶意篡改。